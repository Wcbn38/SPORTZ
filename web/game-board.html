<!DOCTYPE html>
<script src="/utilities.js"></script>
<script>
    function loadServers() {
        document.getElementById("loader").style.display = 'block'
        cookieMap = mapWebPrms(document.cookie)

        args = document.location.href.split('?')[1]
        argsMap = mapWebPrms(args)

        fetch(`${document.location.origin}/game-properties?gameid=${argsMap["gameid"]}`, {
            method: "POST",
            body: "",
            headers: {
                "Content-type": "text/plain; charset=UTF-8",
                "Content-Length": 0,
                "Cookies": cookieMap["pwd"]
            }
        })
        .then((response) => response.json())
        .then((json) => {
            document.getElementById("loader").style.display = 'none'

            playerSection = document.getElementById("players")
            playerSection.innerHTML = ''

            let header = playerSection.appendChild(document.createElement("tr"))
            header.appendChild(document.createElement("th")).innerHTML = "Name"
            header.appendChild(document.createElement("th")).innerHTML = "Vote"
            header.appendChild(document.createElement("th")).innerHTML = "Voted"

            json.forEach(el => {
                const playerEl = document.createElement("tr")

                playerEl.appendChild(document.createElement("th")).innerHTML = el["username"]
                playerEl.appendChild(document.createElement("td")).innerHTML = el["vote"]
                playerEl.appendChild(document.createElement("td")).innerHTML = json.map(e => e['vote'] == el['id']).filter(e => e).length

                if (el["dead"]) {
                    playerEl.classList.add("greyed")
                }

                playerSection.appendChild(playerEl)
            });

            let blankVote = playerSection.appendChild(document.createElement("tr"))
            blankVote.appendChild(document.createElement("th")).innerHTML = "Blank"
            blankVote.appendChild(document.createElement("td")).innerHTML = "N/A"
            blankVote.appendChild(document.createElement("td")).innerHTML = json.map(e => e['vote'] == null).filter(e => e).length

            playerSection.appendChild(blankVote)
        });
    }

    function startGame() {
        fetch(`${document.location.origin}/game-start?gameid=${argsMap["gameid"]}`, {
            method: "POST",
            body: "",
            headers: {
                "Content-type": "text/plain; charset=UTF-8",
                "Content-Length": 0,
                "Cookies": cookieMap["pwd"]
            }
        })
    }

    function setVoteEnable(value) {
        fetch(`${document.location.origin}/game-status?gameid=${argsMap["gameid"]}&enabled=${value}`, {
            method: "POST",
            body: "",
            headers: {
                "Content-type": "text/plain; charset=UTF-8",
                "Content-Length": 0,
                "Cookies": cookieMap["pwd"]
            }
        })
    }
</script>
<html>
    <head>
        <title>
            Game board
        </title>
        <link rel="stylesheet" type="text/css" href="loader.css">
        <link rel="stylesheet" type="text/css" href="admin-general.css">
        <div style="padding: 20px; width: 500px; display: grid; grid-template-columns: auto auto auto auto auto;">
            <button onclick="startGame()" style="width: 120px; margin: 15px;">Start game</button>
            <button onclick="setVoteEnable(true)" style="width: 120px; margin: 15px; background-color: green;">Start vote</button>
            <button onclick="setVoteEnable(false)" style="width: 120px; margin: 15px; background-color: red;">End vote</button>
            <button onclick="loadServers()" style="width: 120px; margin: 15px;">Refresh</button>
            <div style="display: inline-block; margin-left: 8px; margin-top: 10px;" class="loader" id="loader"></div>
        </div>
    </head>
    <body onload="loadServers()">
        <div>
            <table id="players">
            </table>
        </div>
    </body>
</html>